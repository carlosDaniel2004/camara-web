<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reconocimiento Facial</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #main-container { display: flex; flex-wrap: wrap; gap: 40px; justify-content: center; }
        .section { border: 1px solid #ccc; padding: 20px; border-radius: 8px; }
        #container { position: relative; }
        #video { border: 2px solid black; background-color: #333; }
        #canvas { position: absolute; top: 0; left: 0; }
        #status { margin-top: 10px; font-weight: bold; }
        form { display: flex; flex-direction: column; gap: 10px; }
        .flashes { list-style-type: none; padding: 0; }
        .flashes li { color: green; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Reconocimiento Facial Dinámico</h1>
    
    <div id="main-container">
        <div class="section">
            <h2>Cámara en Vivo</h2>
            <div id="container">
                <video id="video" width="640" height="480" autoplay muted></video>
                <canvas id="canvas" width="640" height="480"></canvas>
            </div>
            <p id="status">Iniciando cámara...</p>
        </div>

        <div class="section">
            <h2>Añadir Nueva Persona</h2>
            {% with messages = get_flashed_messages() %}
              {% if messages %}
                <ul class="flashes">
                {% for message in messages %}
                  <li>{{ message }}</li>
                {% endfor %}
                </ul>
              {% endif %}
            {% endwith %}
            <form action="/upload" method="post" enctype="multipart/form-data">
                <label for="name">Nombre:</label>
                <input type="text" id="name" name="name" required>
                <label for="photo">Foto (una cara, mirando al frente):</label>
                <input type="file" id="photo" name="photo" accept="image/*" required>
                <button type="submit">Subir Foto</button>
            </form>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const statusEl = document.getElementById('status');
        let processing = false;

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    statusEl.textContent = "Cámara activa. Analizando...";
                    setInterval(processFrame, 500); // Envía un frame cada 500ms (2 FPS)
                };
            } catch (err) {
                console.error("Error al acceder a la cámara: ", err);
                statusEl.textContent = "Error al acceder a la cámara. Asegúrate de dar permiso.";
            }
        }

        async function processFrame() {
            if (processing) return;
            processing = true;

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            const tempContext = tempCanvas.getContext('2d');
            tempContext.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
            const imageDataURL = tempCanvas.toDataURL('image/jpeg');

            try {
                const response = await fetch('/process_frame', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageDataURL })
                });

                if (!response.ok) throw new Error(`Error del servidor: ${response.status}`);
                
                const results = await response.json();
                drawResults(results);

            } catch (error) {
                console.error('Error al procesar el frame:', error);
            } finally {
                processing = false;
            }
        }

        function drawResults(results) {
            context.clearRect(0, 0, canvas.width, canvas.height);

            if (results.all_faces) {
                results.all_faces.forEach(face => {
                    context.strokeStyle = 'blue';
                    context.lineWidth = 2;
                    context.strokeRect(face.x, face.y, face.w, face.h);
                    context.fillStyle = 'blue';
                    context.font = '16px Arial';
                    context.fillText('Rostro', face.x, face.y > 10 ? face.y - 5 : 10);
                });
            }

            if (results.recognized_faces) {
                results.recognized_faces.forEach(face => {
                    const { x, y, w, h } = face.coords;
                    context.strokeStyle = 'green';
                    context.lineWidth = 3;
                    context.strokeRect(x, y, w, h);
                    context.fillStyle = 'green';
                    context.font = '18px Arial';
                    context.fillText(face.name, x, y > 10 ? y - 5 : 10);
                });
            }
        }

        startCamera();
    </script>
    <a href="{{ url_for('geometry_page') }}">Ir a Detección de Figuras (Video Subido)</a>
    <a href="{{ url_for('realtime_geometry_page') }}" style="margin-left: 20px;">Ir a Detección de Figuras (En Vivo)</a>
</body>
</html>
